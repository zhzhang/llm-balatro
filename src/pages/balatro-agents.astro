---
import BaseHead from '../components/BaseHead.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
import { db, gameRuns, turnHistory, screenshots, eq, desc } from 'astro:db';

// Get all runs with their metadata
const runs = await db
  .select()
  .from(gameRuns)
  .orderBy(desc(gameRuns.startedAt))
  .all();

// Get all turn history and screenshots (we'll organize them client-side)
const allTurns = await db
  .select()
  .from(turnHistory)
  .all();

const allScreenshots = await db
  .select()
  .from(screenshots)
  .all();

// Group turns by run_id for easier access
const turnsByRun = allTurns.reduce((acc, turn) => {
  if (!acc[turn.runId]) acc[turn.runId] = [];
  acc[turn.runId].push(turn);
  return acc;
}, {} as Record<string, typeof allTurns>);

// Group screenshots by run_id
const screenshotsByRun = allScreenshots.reduce((acc, screenshot) => {
  if (!acc[screenshot.runId]) acc[screenshot.runId] = [];
  acc[screenshot.runId].push(screenshot);
  return acc;
}, {} as Record<string, typeof allScreenshots>);

// Sort turns within each run
for (const runId in turnsByRun) {
  turnsByRun[runId].sort((a, b) => {
    if (a.turn !== b.turn) return a.turn - b.turn;
    const typeOrder: Record<string, number> = { 
      'game_state': 1, 
      'response': 2 
    };
    return (typeOrder[a.type] || 3) - (typeOrder[b.type] || 3);
  });
}

// Get unique seeds and agents for filtering
const seeds = [...new Set(runs.map(r => r.seed).filter(Boolean))].sort();
const agents = [...new Set(runs.map(r => r.agent).filter(Boolean))].sort();
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={`Balatro Agents - ${SITE_TITLE}`} description="View Balatro agent gameplay runs" />
    <style>
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
      }

      .layout {
        display: grid;
        grid-template-columns: 400px 1fr;
        gap: 2rem;
        align-items: start;
      }

      .sidebar {
        position: sticky;
        top: 2rem;
        max-height: calc(100vh - 4rem);
        overflow-y: auto;
      }

      .filters {
        background: #f5f5f5;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .filter-group label {
        font-weight: 600;
        font-size: 0.9rem;
      }

      .filter-group select {
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: white;
      }

      .runs-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .run-card {
        border: 2px solid #ddd;
        border-radius: 8px;
        padding: 1rem;
        background: white;
        transition: all 0.2s;
        cursor: pointer;
      }

      .run-card:hover {
        border-color: #999;
      }

      .run-card.selected {
        border-color: #0066cc;
        background: #f0f7ff;
      }

      .run-card.hidden {
        display: none;
      }

      .run-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
      }

      .run-title {
        font-size: 0.95rem;
        font-weight: 600;
      }

      .run-meta {
        font-size: 0.8rem;
        color: #666;
        margin-top: 0.5rem;
      }

      .badge {
        display: inline-block;
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        white-space: nowrap;
      }

      .badge.won {
        background: #d4edda;
        color: #155724;
      }

      .badge.lost {
        background: #f8d7da;
        color: #721c24;
      }

      .badge.in-progress {
        background: #fff3cd;
        color: #856404;
      }

      .run-stats {
        display: flex;
        gap: 1rem;
        margin-top: 0.5rem;
        font-size: 0.8rem;
      }

      .no-results {
        text-align: center;
        padding: 2rem;
        color: #666;
        font-size: 0.9rem;
      }

      .detail-view {
        min-height: 400px;
      }

      .detail-empty {
        text-align: center;
        padding: 4rem;
        color: #999;
      }

      .detail-header {
        background: #f5f5f5;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
      }

      .detail-title {
        font-size: 1.8rem;
        font-weight: 600;
        margin-bottom: 1rem;
      }

      .detail-meta {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
      }

      .meta-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .meta-label {
        font-size: 0.8rem;
        color: #666;
        text-transform: uppercase;
      }

      .meta-value {
        font-size: 1.1rem;
        font-weight: 600;
      }

      .plan-reflection {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #ddd;
      }

      .plan-reflection h3 {
        font-size: 1rem;
        margin-bottom: 0.5rem;
        color: #666;
      }

      .plan-reflection p {
        margin: 0;
        white-space: pre-wrap;
        font-size: 0.9rem;
        line-height: 1.5;
      }

      .turns-list {
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }

      .turn-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        background: white;
      }

      .turn-header {
        background: #333;
        color: white;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .turn-number {
        font-size: 1.2rem;
        font-weight: 600;
      }

      .turn-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.9rem;
      }

      .turn-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        padding: 1.5rem;
      }

      .turn-screenshot {
        grid-column: 1 / -1;
        text-align: center;
        margin-bottom: 1rem;
      }

      .turn-screenshot img {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .data-section {
        display: flex;
        flex-direction: column;
      }

      .section-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: #333;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .json-display {
        background: #f8f8f8;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 1rem;
        overflow-x: auto;
        font-family: 'Monaco', 'Courier New', monospace;
        font-size: 0.85rem;
        line-height: 1.5;
        max-height: 600px;
        overflow-y: auto;
      }

      .json-display pre {
        margin: 0;
      }

      .hand-result {
        background: #e3f2fd;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        font-weight: 500;
        margin-bottom: 0.5rem;
      }

      h1 {
        margin-bottom: 2rem;
      }

      @media (max-width: 1024px) {
        .layout {
          grid-template-columns: 1fr;
        }

        .sidebar {
          position: static;
          max-height: none;
        }

        .turn-content {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <main class="container">
      <h1>Balatro Agent Gameplay</h1>

      <div class="layout">
        <div class="sidebar">
          <div class="filters">
            <div class="filter-group">
              <label for="seed-filter">Seed</label>
              <select id="seed-filter">
                <option value="">All Seeds</option>
                {seeds.map(seed => (
                  <option value={seed}>{seed}</option>
                ))}
              </select>
            </div>

            <div class="filter-group">
              <label for="agent-filter">Agent</label>
              <select id="agent-filter">
                <option value="">All Agents</option>
                {agents.map(agent => (
                  <option value={agent}>{agent}</option>
                ))}
              </select>
            </div>
          </div>

          <div class="runs-list">
            {runs.map(run => {
              const status = run.completed 
                ? (run.won ? 'won' : 'lost') 
                : 'in-progress';
              const statusText = run.completed 
                ? (run.won ? 'Won' : 'Lost') 
                : 'In Progress';

              return (
                <div 
                  class="run-card" 
                  data-seed={run.seed || ''} 
                  data-agent={run.agent || ''}
                  data-run-id={run.runId}
                >
                  <div class="run-header">
                    <div class="run-title">{run.runId.slice(0, 12)}...</div>
                    <span class={`badge ${status}`}>{statusText}</span>
                  </div>
                  <div class="run-meta">
                    {run.seed && <div>üé≤ {run.seed}</div>}
                    {run.agent && <div>ü§ñ {run.agent}</div>}
                  </div>
                  {(run.finalAnte || run.finalRound) && (
                    <div class="run-stats">
                      {run.finalAnte && <span>Ante {run.finalAnte}</span>}
                      {run.finalRound && <span>Round {run.finalRound}</span>}
                    </div>
                  )}
                </div>
              );
            })}
          </div>

          <div class="no-results" style="display: none;">
            No runs found.
          </div>
        </div>

        <div class="detail-view">
          <div class="detail-empty">
            ‚Üê Select a run to view gameplay details
          </div>
        </div>
      </div>
    </main>

    <script define:vars={{ runs, turnsByRun, screenshotsByRun }}>
      const seedFilter = document.getElementById('seed-filter');
      const agentFilter = document.getElementById('agent-filter');
      const runCards = document.querySelectorAll('.run-card');
      const noResults = document.querySelector('.no-results');
      const detailView = document.querySelector('.detail-view');

      let selectedRunId = null;

      function filterRuns() {
        const selectedSeed = seedFilter.value;
        const selectedAgent = agentFilter.value;
        let visibleCount = 0;

        runCards.forEach(card => {
          const cardSeed = card.getAttribute('data-seed') || '';
          const cardAgent = card.getAttribute('data-agent') || '';

          const seedMatch = !selectedSeed || cardSeed === selectedSeed;
          const agentMatch = !selectedAgent || cardAgent === selectedAgent;

          if (seedMatch && agentMatch) {
            card.classList.remove('hidden');
            visibleCount++;
          } else {
            card.classList.add('hidden');
          }
        });

        noResults.style.display = visibleCount === 0 ? 'block' : 'none';
      }

      function showRunDetail(runId) {
        // Update selected state
        runCards.forEach(card => {
          if (card.getAttribute('data-run-id') === runId) {
            card.classList.add('selected');
          } else {
            card.classList.remove('selected');
          }
        });

        selectedRunId = runId;

        // Find the run data
        const run = runs.find(r => r.runId === runId);
        if (!run) return;

        // Get turns and screenshots for this run
        const turns = turnsByRun[runId] || [];
        const screenshots = screenshotsByRun[runId] || [];

        // Group turns by turn number
        const turnGroups = new Map();
        
        for (const turn of turns) {
          if (!turnGroups.has(turn.turn)) {
            turnGroups.set(turn.turn, {
              turn: turn.turn,
              ante: turn.ante,
              handResult: turn.handResult,
              timestamp: turn.timestamp
            });
          }
          
          const group = turnGroups.get(turn.turn);
          
          if (turn.type === 'game_state') {
            try {
              group.gameState = JSON.parse(turn.blob);
            } catch (e) {
              group.gameState = { error: 'Failed to parse game state' };
            }
          } else if (turn.type === 'response') {
            try {
              group.response = JSON.parse(turn.blob);
            } catch (e) {
              group.response = { error: 'Failed to parse response' };
            }
          }
        }

        // Add screenshots
        for (const screenshot of screenshots) {
          const group = turnGroups.get(screenshot.turn);
          if (group && screenshot.screenshotData) {
            group.screenshot = `data:image/png;base64,${screenshot.screenshotData}`;
          }
        }

        const sortedTurns = Array.from(turnGroups.values()).sort((a, b) => a.turn - b.turn);

        // Render detail view
        const status = run.completed ? (run.won ? 'won' : 'lost') : 'in-progress';
        const statusText = run.completed ? (run.won ? 'Won' : 'Lost') : 'In Progress';

        let html = `
          <div class="detail-header">
            <div class="detail-title">
              Run: ${run.runId}
              <span class="badge ${status}">${statusText}</span>
            </div>
            <div class="detail-meta">
              ${run.seed ? `<div class="meta-item"><div class="meta-label">Seed</div><div class="meta-value">${run.seed}</div></div>` : ''}
              ${run.agent ? `<div class="meta-item"><div class="meta-label">Agent</div><div class="meta-value">${run.agent}</div></div>` : ''}
              ${run.finalAnte ? `<div class="meta-item"><div class="meta-label">Final Ante</div><div class="meta-value">${run.finalAnte}</div></div>` : ''}
              ${run.finalRound ? `<div class="meta-item"><div class="meta-label">Final Round</div><div class="meta-value">${run.finalRound}</div></div>` : ''}
              ${run.bestHand ? `<div class="meta-item"><div class="meta-label">Best Hand</div><div class="meta-value">${run.bestHand.toLocaleString()}</div></div>` : ''}
              <div class="meta-item"><div class="meta-label">Turns</div><div class="meta-value">${sortedTurns.length}</div></div>
            </div>
            ${run.gamePlan || run.reflection ? `
              <div class="plan-reflection">
                ${run.gamePlan ? `<div><h3>Game Plan:</h3><p>${run.gamePlan}</p></div>` : ''}
                ${run.reflection ? `<div style="margin-top: 1rem;"><h3>Reflection:</h3><p>${run.reflection}</p></div>` : ''}
              </div>
            ` : ''}
          </div>
          <div class="turns-list">
        `;

        for (const turn of sortedTurns) {
          html += `
            <div class="turn-card" id="turn-${turn.turn}">
              <div class="turn-header">
                <div class="turn-number">Turn ${turn.turn}</div>
                <div class="turn-meta">
                  ${turn.ante ? `<span>Ante ${turn.ante}</span>` : ''}
                  ${turn.timestamp ? `<span>${new Date(turn.timestamp).toLocaleTimeString()}</span>` : ''}
                </div>
              </div>
              <div class="turn-content">
                ${turn.screenshot ? `
                  <div class="turn-screenshot">
                    <img src="${turn.screenshot}" alt="Screenshot for turn ${turn.turn}" />
                  </div>
                ` : ''}
                ${turn.gameState ? `
                  <div class="data-section">
                    <div class="section-title">üéÆ Game State</div>
                    <div class="json-display"><pre>${JSON.stringify(turn.gameState, null, 2)}</pre></div>
                  </div>
                ` : ''}
                ${turn.response ? `
                  <div class="data-section">
                    <div class="section-title">ü§ñ Bot Response</div>
                    ${turn.handResult ? `<div class="hand-result">Hand Result: ${turn.handResult}</div>` : ''}
                    <div class="json-display"><pre>${JSON.stringify(turn.response, null, 2)}</pre></div>
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        }

        html += '</div>';

        detailView.innerHTML = html;
      }

      seedFilter.addEventListener('change', filterRuns);
      agentFilter.addEventListener('change', filterRuns);

      runCards.forEach(card => {
        card.addEventListener('click', () => {
          const runId = card.getAttribute('data-run-id');
          if (runId) {
            showRunDetail(runId);
          }
        });
      });
    </script>
  </body>
</html>
