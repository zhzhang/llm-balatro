---
import BaseHead from "../components/BaseHead.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "../consts";
import { readFile } from "fs/promises";
import { join } from "path";

// Load turn history index from static files
const indexPath = join(process.cwd(), "public", "turn-history", "index.json");
const indexContent = await readFile(indexPath, "utf-8");
const runMetadata = JSON.parse(indexContent) as Array<{
  agent: string;
  seed: string;
  runId: string;
  outcome: string;
  turns: number[];
}>;

// Create a map for quick lookup: agent -> seed -> outcome
const outcomeMap = new Map<string, Map<string, string>>();
for (const run of runMetadata) {
  if (!outcomeMap.has(run.agent)) {
    outcomeMap.set(run.agent, new Map());
  }
  outcomeMap.get(run.agent)!.set(run.seed, run.outcome);
}
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
    <style>
      /* Custom CSS variables for colors not in Tailwind theme */
      :root {
        --text-link: var(--color-accent);
      }

      /* Selected table cell outline */
      td.selected {
        outline: 3px solid #2563eb;
        outline-offset: -3px;
      }

      /* Turn navigation buttons */
      .turn-controls button:not(:disabled):hover {
        background-color: var(--color-accent-hover) !important;
      }

      /* Turn slider styling */
      .turn-slider {
        -webkit-appearance: none;
        appearance: none;
        height: 8px;
        border-radius: 4px;
        background: var(--color-border-light);
        outline: none;
        cursor: pointer;
      }

      .turn-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--color-accent);
        cursor: pointer;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: transform 0.15s ease;
      }

      .turn-slider::-webkit-slider-thumb:hover {
        background: var(--color-accent-hover);
      }

      .turn-slider::-moz-range-thumb {
        width: 6px;
        height: 14px;
        border-radius: 3px;
        background: var(--color-accent);
        cursor: pointer;
        border: none;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        transition: background 0.15s ease;
      }

      .turn-slider::-moz-range-thumb:hover {
        background: var(--color-accent-hover);
      }

      .turn-slider::-moz-range-track {
        height: 8px;
        border-radius: 4px;
        background: var(--color-border-light);
      }

      /* Turn browser layout - grid ensures text panel matches screenshot height */
      .turn-browser-layout {
        display: grid;
        grid-template-columns: 1fr minmax(0, 36rem);
        gap: 1rem;
      }

      /* Example state layout - grid ensures JSON panel matches screenshot height */
      .example-state-layout {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 36rem);
        gap: 1rem;
      }

      .state-json-panel {
        position: relative;
        min-height: 0;
      }

      .state-json-content {
        position: absolute;
        inset: 0;
        overflow-y: auto;
        overflow-x: auto;
        padding: 1rem;
        background-color: var(--color-bg-secondary);
        border-radius: 0.5rem;
        margin: 0;
        white-space: pre;
      }

      .reasoning-panel {
        position: relative;
        min-height: 0;
      }

      .reasoning-content {
        position: absolute;
        inset: 0;
        overflow-y: auto;
        padding: 0 1rem;
      }

      /* Term popover tooltips */
      .term-popover::after {
        content: attr(data-definition);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%) translateY(-8px);
        background-color: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 6px;
        font-size: 0.875rem;
        line-height: 1.5;
        white-space: normal;
        width: max-content;
        max-width: 280px;
        text-align: left;
        opacity: 0;
        pointer-events: none;
        transition:
          opacity 0.2s ease,
          transform 0.2s ease;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .term-popover::before {
        content: "";
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%) translateY(-2px);
        border: 6px solid transparent;
        border-top-color: rgba(0, 0, 0, 0.9);
        opacity: 0;
        pointer-events: none;
        transition:
          opacity 0.2s ease,
          transform 0.2s ease;
        z-index: 1000;
      }

      .term-popover:hover::after,
      .term-popover:hover::before {
        opacity: 1;
        transform: translateX(-50%) translateY(-4px);
      }

      .term-popover:hover::before {
        transform: translateX(-50%) translateY(2px);
      }

      @media (max-width: 768px) {
        main {
          padding: 4rem 1.5rem !important;
        }

        .article-header {
          margin-bottom: 3rem !important;
        }

        .article-subtitle {
          font-size: 1.125rem !important;
        }

        .table-container {
          width: calc(100vw - 3rem) !important;
          overflow-x: auto;
        }

        .turn-details {
          height: auto !important;
          max-height: 500px !important;
        }

        .turn-controls {
          grid-template-columns: 1fr !important;
          grid-template-rows: auto auto auto !important;
          gap: 0.75rem !important;
        }

        .turn-controls button:first-child {
          justify-self: stretch !important;
        }

        .turn-controls button:last-child {
          justify-self: stretch !important;
        }

        .turn-controls button {
          width: 100% !important;
        }

        .term-popover::after {
          max-width: 200px !important;
          font-size: 0.8rem !important;
        }

        .example-state-layout {
          grid-template-columns: 1fr !important;
        }

        .state-json-panel {
          position: relative !important;
          height: auto !important;
          max-height: 300px !important;
        }

        .state-json-content {
          position: relative !important;
          inset: auto !important;
        }
      }
    </style>
  </head>
  <body>
    <main class="max-w-[760px] mx-auto py-20 px-8">
      <header
        class="article-header mb-16 pb-8 border-b"
        style="border-color: var(--color-border-light);"
      >
        <h1 class="mb-4">Can LLMs beat Balatro?</h1>
        <p
          class="article-subtitle text-xl font-normal leading-relaxed"
          style="font-family: var(--font-family-serif); color: var(--color-text-secondary);"
        >
          In short: yes, and now I'm betting on Google to win the AI race.
        </p>
        <p
          class="text-sm mt-2 flex items-center gap-3"
          style="color: var(--color-text-secondary);"
        >
          <a
            href="https://www.linkedin.com/in/zhjzhang/"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-1.5 border-b border-transparent transition-colors duration-200 hover:border-[var(--color-accent)]"
            style="color: var(--color-accent);"
          >
            <svg
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
              class="w-[18px] h-[18px] fill-current"
            >
              <path
                d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"
              ></path>
            </svg>
            Jordan Zhang
          </a>
          <span>•</span>
          <a
            href="https://github.com/zhzhang/llm-balatro/tree/main/experiment-code"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-1.5 border-b border-transparent transition-colors duration-200 hover:border-[var(--color-accent)]"
            style="color: var(--color-accent);"
          >
            <svg
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
              class="w-[18px] h-[18px] fill-current"
            >
              <path
                d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
              ></path>
            </svg>
            Code
          </a>
        </p>
      </header>

      <article class="leading-[1.8]">
        <p>
          <strong>Balatro</strong> is a <span
            class="term-popover relative underline decoration-dotted cursor-help"
            style="text-decoration-color: var(--color-accent); color: inherit;"
            data-definition="A game genre where progress is procedurally generated, features permanent death, and requires players to restart from the beginning when they die."
            >roguelike</span
          >
          <span
            class="term-popover relative underline decoration-dotted cursor-help"
            style="text-decoration-color: var(--color-accent); color: inherit;"
            data-definition="A game genre where players build and customize a deck of cards throughout the game, making strategic choices about which cards to add, remove, or upgrade."
            >deckbuilder</span
          > based on poker that was released in 2024. Players play poker hands to
          earn chips and pass rounds, trying to exceed exponentially increasing chip
          requirement as rounds progress.
        </p>

        <div
          class="my-8 w-[calc(100vw-4rem)] max-w-[1400px] relative left-1/2 -translate-x-1/2 flex gap-6 justify-center items-start"
        >
          <div class="flex-1 flex flex-col items-center">
            <img
              src="/gifs/balatro-1.gif"
              alt="Balatro gameplay 1"
              class="w-full h-auto rounded-lg shadow-md"
            />
            <p
              class="mt-3 text-[0.85rem] text-center"
              style="color: var(--color-text-secondary);"
            >
              1. Start playing regular poker hands to earn money.
            </p>
          </div>
          <div class="flex-1 flex flex-col items-center">
            <img
              src="/gifs/balatro-2.gif"
              alt="Balatro gameplay 2"
              class="w-full h-auto rounded-lg shadow-md"
            />
            <p
              class="mt-3 text-[0.85rem] text-center"
              style="color: var(--color-text-secondary);"
            >
              2. Buy and use power ups to stack the deck in your favor.
            </p>
          </div>
          <div class="flex-1 flex flex-col items-center">
            <img
              src="/gifs/balatro-3.gif"
              alt="Balatro gameplay 3"
              class="w-full h-auto rounded-lg shadow-md"
            />
            <p
              class="mt-3 text-[0.85rem] text-center"
              style="color: var(--color-text-secondary);"
            >
              3. Build OP combos and win the game.
            </p>
          </div>
        </div>

        <p>Balatro is an interesting test bed for LLM reasoning because:</p>
        <ul>
          <li>
            It is stochastic with an enormous branching factor, requiring
            probabilistic reasoning to make optimal decisions.
          </li>
          <li>
            Long range planning and execution are needed to curate strong enough combos and decks that can keep up with
            the exponentially increasing chip requirement.
          </li>
          <li>Being turn-based, with no real-time or visuospatial qualities, the game is playable entirely in text form.</li>
        </ul>

		<div
          class="my-8 w-[calc(100vw-4rem)] max-w-[1400px] relative left-1/2 -translate-x-1/2 border rounded-lg p-4"
          style="border-color: var(--color-border-light);"
        >
          <p class="text-sm mb-4" style="color: var(--color-text-secondary);">
            An example game state and corresponding screenshot from Ante 7:
          </p>
          <div class="example-state-layout">
            <div class="state-json-panel">
              <pre
                class="state-json-content text-xs leading-relaxed"
                style="color: var(--color-text-secondary);"
              >{await readFile(join(process.cwd(), "public", "example-state.json"), "utf-8")}</pre>
            </div>
            <div>
              <img
                src="/turn-history/openai/422J6NUH/170.png"
                alt="Ante 7 game state screenshot"
                class="w-full h-auto border rounded"
                style="border-color: var(--color-border-light);"
              />
            </div>
          </div>
        </div>

        <p>
			As I was interested in the agents' decision making abilities, and not their ability to navigate and click around the game's UI to do things,
			I elected to mod the game to stringify the state as JSON, rather than working with the agents through screenshots. Parts
			of the mod code are available in the <a href="https://github.com/zhzhang/llm-balatro/tree/main/experiment-code" target="_blank" rel="noopener noreferrer">experiment-code</a> repository for your reference,
			though I have not had a chance to formally turn it into a <a href="https://github.com/Steamodded/smods" target="_blank" rel="noopener noreferrer">Steamodded</a> mod.
        </p>

        <p>
		The experimental setup was as follows:
		</p>
		<ul>
		<li>
			I had models from OpenAI, Claude, and Google each play 10 games
			using the same set of 10 run seeds, to reduce the effect of run-to-run variance in the comparison.
		</li>
		<li>
			The maximum thinking effort setting for each model was used.
		</li>
		<li>
			I gave a system prompt that explained the general rules and flow of the game, which can be viewed <a href="https://github.com/zhzhang/llm-balatro/blob/main/experiment-code/prompts.py#L88" target="_blank" rel="noopener noreferrer">here</a>.
			The system prompt does not provide any information on specific instances of game objects like jokers, cards, consumable, or bosses, and does not give any strategies for playing the game.
		</li>
		<li>
			Because the rules for scoring hands can involve very long sequences of cards triggering compounding special effects, I helped the agent gauge the amount of chips it might earn by playing a hand by providing a history of the last 7 hands played.
			This backwards looking memory of recent hands played is similar in feeling to how a human player gauges how "strong" their next played hand might be.
		</li>
		<li>
			In addition to the current state, I also provided the state, action taken, and agent's reasoning for the last 3 turns, to help maintain some tactical continuity across turns. 
		</li>
		<li>
			All games were played on White Stake (base/easiest difficulty) and Red Deck (first deck available in the game). Not the biggest challenge in the world, I know.
		</li>
		</ul>
		<p>
		  Here are the results, including the average cost per turn for each model:
        </p>

        <div
          class="table-container my-8 w-[calc(100vw-4rem)] max-w-[1400px] relative left-1/2 -translate-x-1/2 border rounded-lg p-4"
          style="border-color: var(--color-border-light);"
        >
          <table class="outcomes-table w-full border-collapse text-sm">
            <thead>
              <tr>
                <th
                  class="p-3 text-center border font-semibold sticky top-0"
                  style="border-color: var(--color-border-light); background-color: var(--color-bg-secondary);"
                  >Seed</th
                >
                <th
                  class="p-3 text-center border font-semibold sticky top-0"
                  style="border-color: var(--color-border-light); background-color: var(--color-bg-secondary);"
                  >Cost per turn</th
                >
                <th
                  class="p-3 text-center border font-semibold sticky top-0"
                  style="border-color: var(--color-border-light); background-color: var(--color-bg-secondary);"
                  >422J6NUH</th
                >
                <th
                  class="p-3 text-center border font-semibold sticky top-0"
                  style="border-color: var(--color-border-light); background-color: var(--color-bg-secondary);"
                  >PE93PR87</th
                >
                <th
                  class="p-3 text-center border font-semibold sticky top-0"
                  style="border-color: var(--color-border-light); background-color: var(--color-bg-secondary);"
                  >H1Z58VZ6</th
                >
                <th
                  class="p-3 text-center border font-semibold sticky top-0"
                  style="border-color: var(--color-border-light); background-color: var(--color-bg-secondary);"
                  >U15QWQGE</th
                >
                <th
                  class="p-3 text-center border font-semibold sticky top-0"
                  style="border-color: var(--color-border-light); background-color: var(--color-bg-secondary);"
                  >5U4K91D8</th
                >
                <th
                  class="p-3 text-center border font-semibold sticky top-0"
                  style="border-color: var(--color-border-light); background-color: var(--color-bg-secondary);"
                  >2JW2IH4X</th
                >
                <th
                  class="p-3 text-center border font-semibold sticky top-0"
                  style="border-color: var(--color-border-light); background-color: var(--color-bg-secondary);"
                  >22V4E3UE</th
                >
                <th
                  class="p-3 text-center border font-semibold sticky top-0"
                  style="border-color: var(--color-border-light); background-color: var(--color-bg-secondary);"
                  >M8KADSBQ</th
                >
                <th
                  class="p-3 text-center border font-semibold sticky top-0"
                  style="border-color: var(--color-border-light); background-color: var(--color-bg-secondary);"
                  >M3F6LPGY</th
                >
                <th
                  class="p-3 text-center border font-semibold sticky top-0"
                  style="border-color: var(--color-border-light); background-color: var(--color-bg-secondary);"
                  >84N5GIYF</th
                >
              </tr>
            </thead>
            <tbody>
              <tr>
                <th
                  class="p-3 border font-semibold text-left"
                  style="border-color: var(--color-border-light); background-color: var(--color-bg-secondary);"
                  >claude-4.5-sonnet</th
                >
                <td
                  class="p-3 text-center border"
                  style="border-color: var(--color-border-light);">$0.058</td
                >
                <td
                  class="clickable lost p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-red-50 text-red-500"
                  style="border-color: var(--color-border-light);"
                  data-agent="claude"
                  data-seed="422J6NUH">Ante 5</td
                >
                <td
                  class="clickable lost p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-red-50 text-red-500"
                  style="border-color: var(--color-border-light);"
                  data-agent="claude"
                  data-seed="PE93PR87">Ante 3</td
                >
                <td
                  class="clickable lost p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-red-50 text-red-500"
                  style="border-color: var(--color-border-light);"
                  data-agent="claude"
                  data-seed="H1Z58VZ6">Ante 5</td
                >
                <td
                  class="clickable lost p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-red-50 text-red-500"
                  style="border-color: var(--color-border-light);"
                  data-agent="claude"
                  data-seed="U15QWQGE">Ante 4</td
                >
                <td
                  class="clickable lost p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-red-50 text-red-500"
                  style="border-color: var(--color-border-light);"
                  data-agent="claude"
                  data-seed="5U4K91D8">Ante 6</td
                >
                <td
                  class="clickable lost p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-red-50 text-red-500"
                  style="border-color: var(--color-border-light);"
                  data-agent="claude"
                  data-seed="2JW2IH4X">Ante 6</td
                >
                <td
                  class="clickable lost p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-red-50 text-red-500"
                  style="border-color: var(--color-border-light);"
                  data-agent="claude"
                  data-seed="22V4E3UE">Ante 6</td
                >
                <td
                  class="clickable lost p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-red-50 text-red-500"
                  style="border-color: var(--color-border-light);"
                  data-agent="claude"
                  data-seed="M8KADSBQ">Ante 5</td
                >
                <td
                  class="clickable lost p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-red-50 text-red-500"
                  style="border-color: var(--color-border-light);"
                  data-agent="claude"
                  data-seed="M3F6LPGY">Ante 2</td
                >
                <td
                  class="clickable lost p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-red-50 text-red-500"
                  style="border-color: var(--color-border-light);"
                  data-agent="claude"
                  data-seed="84N5GIYF">Ante 4</td
                >
              </tr>
              <tr>
                <th
                  class="p-3 border font-semibold text-left"
                  style="border-color: var(--color-border-light); background-color: var(--color-bg-secondary);"
                  >gpt-5.2</th
                >
                <td
                  class="p-3 text-center border"
                  style="border-color: var(--color-border-light);">$0.034</td
                >
                <td
                  class="clickable lost p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-red-50 text-red-500"
                  style="border-color: var(--color-border-light);"
                  data-agent="openai"
                  data-seed="422J6NUH">Ante 7</td
                >
                <td
                  class="clickable won p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-green-50 text-green-600 font-semibold"
                  style="border-color: var(--color-border-light);"
                  data-agent="openai"
                  data-seed="PE93PR87">WON</td
                >
                <td
                  class="clickable lost p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-red-50 text-red-500"
                  style="border-color: var(--color-border-light);"
                  data-agent="openai"
                  data-seed="H1Z58VZ6">Ante 6</td
                >
                <td
                  class="clickable won p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-green-50 text-green-600 font-semibold"
                  style="border-color: var(--color-border-light);"
                  data-agent="openai"
                  data-seed="U15QWQGE">WON</td
                >
                <td
                  class="clickable lost p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-red-50 text-red-500"
                  style="border-color: var(--color-border-light);"
                  data-agent="openai"
                  data-seed="5U4K91D8">Ante 7</td
                >
                <td
                  class="clickable lost p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-red-50 text-red-500"
                  style="border-color: var(--color-border-light);"
                  data-agent="openai"
                  data-seed="2JW2IH4X">Ante 5</td
                >
                <td
                  class="clickable lost p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-red-50 text-red-500"
                  style="border-color: var(--color-border-light);"
                  data-agent="openai"
                  data-seed="22V4E3UE">Ante 5</td
                >
                <td
                  class="clickable lost p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-red-50 text-red-500"
                  style="border-color: var(--color-border-light);"
                  data-agent="openai"
                  data-seed="M8KADSBQ">Ante 5</td
                >
                <td
                  class="clickable lost p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-red-50 text-red-500"
                  style="border-color: var(--color-border-light);"
                  data-agent="openai"
                  data-seed="M3F6LPGY">Ante 4</td
                >
                <td
                  class="clickable won p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-green-50 text-green-600 font-semibold"
                  style="border-color: var(--color-border-light);"
                  data-agent="openai"
                  data-seed="84N5GIYF">WON</td
                >
              </tr>
              <tr>
                <th
                  class="p-3 border font-semibold text-left"
                  style="border-color: var(--color-border-light); background-color: var(--color-bg-secondary);"
                  >gemini-3-flash</th
                >
                <td
                  class="p-3 text-center border"
                  style="border-color: var(--color-border-light);">$0.008</td
                >
                <td
                  class="clickable won p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-green-50 text-green-600 font-semibold"
                  style="border-color: var(--color-border-light);"
                  data-agent="gemini"
                  data-seed="422J6NUH">WON</td
                >
                <td
                  class="clickable won p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-green-50 text-green-600 font-semibold"
                  style="border-color: var(--color-border-light);"
                  data-agent="gemini"
                  data-seed="PE93PR87">WON</td
                >
                <td
                  class="clickable won p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-green-50 text-green-600 font-semibold"
                  style="border-color: var(--color-border-light);"
                  data-agent="gemini"
                  data-seed="H1Z58VZ6">WON</td
                >
                <td
                  class="clickable won p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-green-50 text-green-600 font-semibold"
                  style="border-color: var(--color-border-light);"
                  data-agent="gemini"
                  data-seed="U15QWQGE">WON</td
                >
                <td
                  class="clickable won p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-green-50 text-green-600 font-semibold"
                  style="border-color: var(--color-border-light);"
                  data-agent="gemini"
                  data-seed="5U4K91D8">WON</td
                >
                <td
                  class="clickable won p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-green-50 text-green-600 font-semibold"
                  style="border-color: var(--color-border-light);"
                  data-agent="gemini"
                  data-seed="2JW2IH4X">WON</td
                >
                <td
                  class="clickable lost p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-red-50 text-red-500"
                  style="border-color: var(--color-border-light);"
                  data-agent="gemini"
                  data-seed="22V4E3UE">Ante 7</td
                >
                <td
                  class="clickable won p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-green-50 text-green-600 font-semibold"
                  style="border-color: var(--color-border-light);"
                  data-agent="gemini"
                  data-seed="M8KADSBQ">WON</td
                >
                <td
                  class="clickable lost p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-red-50 text-red-500"
                  style="border-color: var(--color-border-light);"
                  data-agent="gemini"
                  data-seed="M3F6LPGY">Ante 4</td
                >
                <td
                  class="clickable won p-3 text-center border cursor-pointer transition-all duration-200 hover:scale-105 hover:shadow-lg bg-green-50 text-green-600 font-semibold"
                  style="border-color: var(--color-border-light);"
                  data-agent="gemini"
                  data-seed="84N5GIYF">WON</td
                >
              </tr>
            </tbody>
          </table>
          <p class="mb-4 text-center italic text-sm" style="color: var(--color-text-secondary); opacity: 0.85;">
            Select a run from the table above to view the turn-by-turn history and agent reasoning of that run.
          </p>
          <div id="turn-browser" class="max-w-full">
            <div class="turn-browser-layout">
              <div class="bg-white p-4 rounded">
                <div class="turn-controls mb-4">
                  <div class="flex items-center gap-3">
                    <button
                      id="prev-turn-btn"
                      class="px-2 h-5 rounded text-xs transition-colors duration-200 disabled:opacity-40 disabled:cursor-not-allowed flex items-center justify-center"
                      style="background-color: var(--color-accent); color: white; border: none;"
                      disabled
                      title="Previous turn (←)"
                    >
                      ←
                    </button>
                    <input
                      type="range"
                      id="turn-slider"
                      min="0"
                      max="0"
                      value="0"
                      class="turn-slider flex-1"
                    />
                    <button
                      id="next-turn-btn"
                      class="px-2 h-5 rounded text-xs transition-colors duration-200 disabled:opacity-40 disabled:cursor-not-allowed flex items-center justify-center"
                      style="background-color: var(--color-accent); color: white; border: none;"
                      disabled
                      title="Next turn (→)"
                    >
                      →
                    </button>
                  </div>
                  <div
                    id="turn-indicator"
                    class="text-center font-medium mt-2 text-sm"
                    style="color: var(--color-text-secondary);"
                  >
                    Turn 1 of 1
                  </div>
                </div>
                <img
                  id="screenshot-img"
                  alt="Game state screenshot"
                  class="w-full h-auto border rounded block"
                  style="border-color: var(--color-border-light);"
                  src="/turn-history/claude/22V4E3UE/0.png"
                />
              </div>
              <div class="reasoning-panel">
                <div class="reasoning-content">
                  <h3 id="action-heading" class="text-lg font-semibold mb-3">Agent Reasoning</h3>
                  <div
                    id="reasoning-text"
                    class="text-sm leading-relaxed whitespace-pre-wrap"
                    style="color: var(--color-text-secondary);"
                  >
                    Loading...
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div
            id="loading-message"
            class="text-center py-8"
            style="display: none;"
          >
            Loading turn history...
          </div>
        </div>
      </article>
	  <h2 class="text-2xl font-semibold mb-4">An unexpected outcome</h2>
      <p>
        Notably, gemini-3-<em>flash</em> trounces both claude-4.5-sonnet and gpt-5.2,
        despite the latter two being bigger and more expensive. I originally planned to 
		compare the "default" model tier for each company, and given that I started with Claude (and was seeing the above performances),
		was even in the process of implementing <a href="https://arxiv.org/abs/2303.11366" target="_blank" rel="noopener noreferrer">Reflexion</a>
	, <a href="https://deepmind.google/blog/alphaevolve-a-gemini-powered-coding-agent-for-designing-advanced-algorithms/" target="_blank" rel="noopener noreferrer">AlphaEvolve</a>
	and <a href="https://voyager.minedojo.org/" target="_blank" rel="noopener noreferrer">Voyager</a>-inspired approaches to help the agent develop for itself a set of useful gameplay policies.
		However, when by chance I swapped to gemini-3-flash for a quick point of comparison, I was shocked to see that it crushed its first run while claude-4.5-sonnet was struggling to reliably get to Ante 7.
    Not only that, it had built a deck of nearly entirely clubs cards by the end of the run, showing that its strategy was highly coherent throughout the 284 turn run.
      </p>
      <div
      class="my-8 w-[calc(100vw-4rem)] max-w-[1400px] relative left-1/2 -translate-x-1/2 flex gap-6 justify-center items-start"
    >
      <div class="flex-1 flex flex-col items-center">
        <img
          src="/gifs/balatro-win.gif"
          alt="Balatro win"
          class="w-1/2 h-auto rounded-lg shadow-md"
        />
        <p
          class="mt-3 text-[0.85rem] text-center"
          style="color: var(--color-text-secondary);"
        >
        gemini-3-flash wins the game with a deck full of clubs.
        </p>
      </div>
    </div> 
	  <p>
		<a
          href="#turn-browser"
          onclick="selectRunAndTurn('gemini', '5U4K91D8', 9); return false;"
          class="border-b border-transparent transition-colors duration-200 hover:border-[var(--color-accent)] cursor-pointer"
          style="color: var(--color-accent);"
        >Turn 9 of the gemini run on seed 5U4K91D8</a> is what tipped me off to what was happening.
		In its reasoning, gemini mentions offhandedly that the Blank Voucher, although it says "Does nothing?" as the textual description of its effect
		 (which is what the agent sees), actually unlocks the Antimatter Voucher for later purchase in the run, which allows the player to have an extra joker slot.
		The thing is <em>none of this information is in the system prompt or the state passed to the model</em>.
	  </p>

	  <p>
		Scrolling through the turn-by-turn history of gemini runs, it becomes clear that gemini simply <em>knew more</em> about the game
		than the other two models. As a result, it also had some gameplay habits that could technically be arrived at by reasoning alone,
		but the other models could not reliably replicate. It:
	  </p>
	  <ul>
		<li>Knew instinctively to try and beat rounds with as few hands as possible to earn an extra $1 per hand, averaging 1.59 hands played per round vs 2.07 for claude and 2.08 for gpt.
			This is despite the hand payout being part of the system prompt.
			For example, it <a
          href="#turn-browser"
          onclick="selectRunAndTurn('gemini', '22V4E3UE', 4); return false;"
          class="border-b border-transparent transition-colors duration-200 hover:border-[var(--color-accent)] cursor-pointer"
          style="color: var(--color-accent);"
        >opted to discard and redraw two low diamond cards</a> in order to try and pass the round with a single hand, whereas claude
		<a
          href="#turn-browser"
          onclick="selectRunAndTurn('claude', 'M8KADSBQ', 5); return false;"
          class="border-b border-transparent transition-colors duration-200 hover:border-[var(--color-accent)] cursor-pointer"
          style="color: var(--color-accent);"
        >slams the flush with a discard left over</a> in a similar situation.
		</li>
		<li>
			Discarded more aggressively, and <em>remembered</em> that it <em>could</em> discard more often than the other two models, which is consistent with the goal of trying to pass the round with a single hand.
			Claude often 
			<a
          href="#turn-browser"
          onclick="selectRunAndTurn('claude', 'M3F6LPGY', 28); return false;"
          class="border-b border-transparent transition-colors duration-200 hover:border-[var(--color-accent)] cursor-pointer"
          style="color: var(--color-accent);"
        >forgot it could discard</a> and redraw cards to shape its hand, and lost at avoidable times with resources left to spend.
		</li>
		<li>
			Maintained 2-3x as much money in reserve on average, $22.71, compared to $9.25 for claude and $7.70 for gpt.
			This is because money in reserve earns $1 of interest per $5 held upon winning a round, up to a maximum of $25 ($5 of interest), something that was noted in the system prompt.
			Gemini maintains about as much money in reserve as the maximum interest gain allows, thereby maximizing its economy and optionality in shops.
		</li>
		<li>
			Understood that it could (and should) make modifications to the deck itself with tarot cards. By the <a href="#turn-browser" onclick="selectRunAndTurn('gemini', '422J6NUH', 284); return false;" class="border-b border-transparent transition-colors duration-200 hover:border-[var(--color-accent)] cursor-pointer" style="color: var(--color-accent);">end of the 422J6NUH run</a>, it had a deck composed
			nearly entirely of clubs cards, while the other agents typically didn't understand how to slowly change their deck composition over time.
		</li>
	  </ul>
	  <p>
		Because these are idiosyncrasies of Balatro but not poker, the other two models had to rely on sheer comprehension and reasoning to play the game, and to an extent had to forget their knowledge of poker that was being induced by the overall vocabulary of the game, to perform effectively.
	  </p>

	  <h2 class="text-2xl font-semibold mb-4">Why Google is going to win the AI race</h2>
      <p>
		Given how big the performance gap is, and the clues that point to the fact that it is knowledge based, not reasoning based,
		the source of the gap must be the pretraining data mix.
    When I originally started the agent development, I searched for a textual guide (i.e. on Reddit) to see if I could get Claude to win if I gave it a manually written strategy.
		While written coherent written guides that went beyond individual tips and tricks were hard to find, Youtube content of this sort was abundant, probably outnumbering written content for Balatro by at least 10x.
		</p>
	<p>
		And not just for Balatro, Google possesses, through Youtube, high fidelity multi-modal content on pretty much any topic you can imagine,
		let alone the user-action data emitted by the rest of its portfolio, from Gmail to Gsuite to Maps to the search engine itself.
		Among the major foundation model companies, Google alone (since Microsoft is not in this race) has products in which its existing users live, work, <em>and</em> play,
    a massive advantage over model builders that are starting from scraping the internet, with no existing product portfolio to act as data source and distribution.
      </p>

      <p>
		The <a href="http://www.incompleteideas.net/IncIdeas/BitterLesson.html" target="_blank" rel="noopener noreferrer">Bitter Lesson</a>-adjacent truth, highlighted by this experiment, is that the team that has better data is going to have better results for 10x cheaper inference than 
		the team that must make up for this gap with more clever reasoning techniques, and Google is just much more likely to have any particular topic be in distribution than the other model companies.
      </p>
	  
	  <h2 class="text-2xl font-semibold mb-4">What's next?</h2>
	  <p>
	  Admittedly this initial experiment was done at the easiest difficulty setting, and with a single deck.
	  As far as Balatro goes, we've only made it past the lobby with LLMs. There are 7 more difficulties, which add challenges like:
	  </p>
	  <ul>
		<li>Reducing rewards for winning rounds</li>
		<li>Increasing the chips needed to pass each round</li>
		<li>Making power ups cost more, be temporary, or most interestingly, be unable to be sold, making strategy pivots more challenging.</li>
	  </ul>
	  <p>
		Achieving good win rates on higher difficulties may require the Reflexion/Voyager/AlphaEvolve-style approaches that were unnecesary at base difficulty.
	  </p>

	  <p>
		Moreover, Balatro remains an interesting test bed to study long range reasoning in LLMs, and it has an extensive community of modders who are constantly creating new game mechanics
    that are out-of-distribution even for Gemini.
    In general, games are great tests of reasoning and long-term planning, and creating a general game-playing framework for benchmarking LLMs is a promising direction for the future.
	  </p>
    </main>

    <footer
      class="max-w-[760px] mx-auto py-8 px-8 border-t text-center text-sm"
      style="border-color: var(--color-border-light); color: var(--color-text-secondary);"
    >
      <p>
        © {new Date().getFullYear()}
        <a
          href="https://www.linkedin.com/in/zhjzhang/"
          target="_blank"
          rel="noopener noreferrer"
          class="border-b border-transparent transition-colors duration-200 hover:border-[var(--color-accent)]"
          style="color: var(--color-accent);"
        >
          Jordan Zhang
        </a>
      </p>
    </footer>

    <script is:inline define:vars={{ runMetadata }}>
      // State for current selection
      let currentAgent = null;
      let currentSeed = null;
      let currentTurnIndex = 0;
      let currentTurns = [];

      // DOM elements
      const screenshotImg = document.getElementById("screenshot-img");
      const reasoningText = document.getElementById("reasoning-text");
      const actionHeading = document.getElementById("action-heading");
      const turnIndicator = document.getElementById("turn-indicator");
      const prevBtn = document.getElementById("prev-turn-btn");
      const nextBtn = document.getElementById("next-turn-btn");
      const turnSlider = document.getElementById("turn-slider");

      // Debounce utility
      function debounce(fn, delay) {
        let timeoutId;
        return function (...args) {
          clearTimeout(timeoutId);
          timeoutId = setTimeout(() => fn.apply(this, args), delay);
        };
      }

      // Find run metadata by agent and seed
      function findRun(agent, seed) {
        return runMetadata.find((r) => r.agent === agent && r.seed === seed);
      }

      // Update the turn display
      async function updateTurnDisplay() {
        if (!currentAgent || !currentSeed || currentTurns.length === 0) return;

        const turn = currentTurns[currentTurnIndex];

        // Update screenshot
        screenshotImg.src = `/turn-history/${currentAgent}/${currentSeed}/${turn}.png`;

        // Update reasoning and action
        try {
          const response = await fetch(
            `/turn-history/${currentAgent}/${currentSeed}/${turn}.json`,
          );
          const data = await response.json();
          reasoningText.textContent =
            data.reasoning || "No reasoning available";
          actionHeading.textContent =
            data.action || "Agent Action";
        } catch (e) {
          reasoningText.textContent = "Failed to load reasoning";
          actionHeading.textContent = "Agent Action";
        }

        // Update turn indicator
        turnIndicator.textContent = `Turn ${currentTurnIndex + 1} of ${currentTurns.length}`;

        // Update button states
        prevBtn.disabled = currentTurnIndex === 0;
        nextBtn.disabled = currentTurnIndex === currentTurns.length - 1;

        // Update slider
        turnSlider.value = currentTurnIndex;
      }

      // Select a run from the table
      function selectRun(agent, seed) {
        const run = findRun(agent, seed);
        if (!run) return;

        // Update selection state
        currentAgent = agent;
        currentSeed = seed;
        currentTurns = run.turns;
        currentTurnIndex = 0;

        // Update slider range
        turnSlider.max = currentTurns.length - 1;
        turnSlider.value = 0;

        // Clear previous selection
        document
          .querySelectorAll("td.selected")
          .forEach((td) => td.classList.remove("selected"));

        // Highlight selected cell
        const cell = document.querySelector(
          `td[data-agent="${agent}"][data-seed="${seed}"]`,
        );
        if (cell) cell.classList.add("selected");

        updateTurnDisplay();
      }

      // Select a run and navigate to a specific turn (1-indexed)
      function selectRunAndTurn(agent, seed, turnNumber) {
        const run = findRun(agent, seed);
        if (!run) return;

        // Update selection state
        currentAgent = agent;
        currentSeed = seed;
        currentTurns = run.turns;
        currentTurnIndex = Math.min(turnNumber - 1, currentTurns.length - 1);

        // Update slider range
        turnSlider.max = currentTurns.length - 1;
        turnSlider.value = currentTurnIndex;

        // Clear previous selection
        document
          .querySelectorAll("td.selected")
          .forEach((td) => td.classList.remove("selected"));

        // Highlight selected cell
        const cell = document.querySelector(
          `td[data-agent="${agent}"][data-seed="${seed}"]`,
        );
        if (cell) cell.classList.add("selected");

        updateTurnDisplay();

        // Scroll the turn browser into view
        document.getElementById("turn-browser").scrollIntoView({ behavior: "smooth", block: "start" });
      }

      // Make selectRunAndTurn available globally for inline onclick handlers
      window.selectRunAndTurn = selectRunAndTurn;

      // Navigation handlers
      prevBtn.addEventListener("click", () => {
        if (currentTurnIndex > 0) {
          currentTurnIndex--;
          updateTurnDisplay();
        }
      });

      nextBtn.addEventListener("click", () => {
        if (currentTurnIndex < currentTurns.length - 1) {
          currentTurnIndex++;
          updateTurnDisplay();
        }
      });

      // Slider navigation (debounced to reduce fetches)
      const debouncedUpdateTurnDisplay = debounce(updateTurnDisplay, 150);
      turnSlider.addEventListener("input", () => {
        currentTurnIndex = parseInt(turnSlider.value, 10);
        // Update only the turn indicator immediately for responsiveness
        if (currentTurns.length > 0) {
          turnIndicator.textContent = `Turn ${currentTurnIndex + 1} of ${currentTurns.length}`;
          prevBtn.disabled = currentTurnIndex === 0;
          nextBtn.disabled = currentTurnIndex === currentTurns.length - 1;
        }
        // Debounce the image and JSON fetch
        debouncedUpdateTurnDisplay();
      });

      // Keyboard navigation
      document.addEventListener("keydown", (e) => {
        if (e.key === "ArrowLeft") {
          prevBtn.click();
        } else if (e.key === "ArrowRight") {
          nextBtn.click();
        }
      });

      // Click handlers for table cells
      document.querySelectorAll("td.clickable").forEach((cell) => {
        cell.addEventListener("click", () => {
          const agent = cell.dataset.agent;
          const seed = cell.dataset.seed;
          selectRun(agent, seed);
        });
      });

      // Initialize with first cell from the table
      const firstCell = document.querySelector("td.clickable");
      if (firstCell) {
        selectRun(firstCell.dataset.agent, firstCell.dataset.seed);
      }
    </script>
  </body>
</html>
